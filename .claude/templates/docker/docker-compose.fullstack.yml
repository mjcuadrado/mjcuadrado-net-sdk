# ==============================================
# Docker Compose Full Stack Template
# ==============================================
# Stack: .NET Backend + React Frontend + PostgreSQL
# Optimizado para: mjcuadrado-net-sdk
# Entornos: development, production
# ==============================================

version: '3.8'

services:
  # ================================
  # PostgreSQL Database
  # ================================
  db:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-myapp}-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-myapp}
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: ${DB_SHARED_BUFFERS:-256MB}
      POSTGRES_MAX_CONNECTIONS: ${DB_MAX_CONNECTIONS:-100}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      # Persistencia de datos
      - postgres_data:/var/lib/postgresql/data
      # Scripts de inicializaci√≥n
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./postgres/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
    networks:
      - backend-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Resource limits (production)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ================================
  # .NET Backend API
  # ================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      # Usar 'development' stage en dev, 'final' en prod
      target: ${DOCKER_BUILD_TARGET:-development}
      args:
        - VERSION=${APP_VERSION:-1.0.0}
    image: ${PROJECT_NAME:-myapp}-backend:${APP_VERSION:-latest}
    container_name: ${PROJECT_NAME:-myapp}-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5000}:80"
      - "${BACKEND_HTTPS_PORT:-5001}:443"
    environment:
      # ASP.NET Core
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:80
      # Database connection
      - ConnectionStrings__DefaultConnection=Host=db;Port=5432;Database=${DB_NAME:-myapp};Username=${DB_USER:-postgres};Password=${DB_PASSWORD:-postgres}
      # Logging
      - Logging__LogLevel__Default=${LOG_LEVEL:-Information}
      - Logging__LogLevel__Microsoft.AspNetCore=${LOG_LEVEL_ASPNET:-Warning}
      # CORS
      - CORS__AllowedOrigins__0=http://localhost:${FRONTEND_PORT:-5173}
      - CORS__AllowedOrigins__1=http://localhost:${FRONTEND_PROD_PORT:-80}
      # JWT (si se usa)
      - JWT__Secret=${JWT_SECRET}
      - JWT__Issuer=${JWT_ISSUER:-myapp}
      - JWT__Audience=${JWT_AUDIENCE:-myapp-users}
      - JWT__ExpirationMinutes=${JWT_EXPIRATION:-60}
    volumes:
      # Hot reload en desarrollo
      - ./backend:/app:delegated
      # Cache de NuGet
      - backend_nuget:/root/.nuget/packages
      # Logs
      - ./logs/backend:/app/logs
    networks:
      - backend-net
      - frontend-net
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Resource limits (production)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ================================
  # React Frontend
  # ================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # Usar 'development' stage en dev, 'final' en prod
      target: ${DOCKER_BUILD_TARGET:-development}
      args:
        - VITE_API_URL=http://localhost:${BACKEND_PORT:-5000}
        - VERSION=${APP_VERSION:-1.0.0}
    image: ${PROJECT_NAME:-myapp}-frontend:${APP_VERSION:-latest}
    container_name: ${PROJECT_NAME:-myapp}-frontend
    restart: unless-stopped
    ports:
      # Dev server (Vite)
      - "${FRONTEND_PORT:-5173}:5173"
      # Production (Nginx)
      - "${FRONTEND_PROD_PORT:-80}:80"
    environment:
      # API URL (runtime)
      - VITE_API_URL=${VITE_API_URL:-http://localhost:${BACKEND_PORT:-5000}}
      # Feature flags
      - VITE_ENABLE_ANALYTICS=${ENABLE_ANALYTICS:-false}
      - VITE_ENABLE_DEBUG=${ENABLE_DEBUG:-false}
    volumes:
      # Hot reload en desarrollo
      - ./frontend/src:/app/src:delegated
      - ./frontend/public:/app/public:delegated
      # Cache de node_modules
      - frontend_node_modules:/app/node_modules
    networks:
      - frontend-net
    depends_on:
      - backend
    # stdin y tty para HMR en desarrollo
    stdin_open: true
    tty: true
    # Resource limits (production)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ================================
  # PgAdmin (Opcional - Solo Development)
  # ================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ${PROJECT_NAME:-myapp}-pgadmin
    restart: unless-stopped
    profiles: ["dev"]
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - backend-net
    depends_on:
      - db

  # ================================
  # Adminer (Alternativa ligera a PgAdmin)
  # ================================
  adminer:
    image: adminer:latest
    container_name: ${PROJECT_NAME:-myapp}-adminer
    restart: unless-stopped
    profiles: ["dev"]
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    networks:
      - backend-net
    depends_on:
      - db
    environment:
      ADMINER_DEFAULT_SERVER: db

# ================================
# Networks
# ================================
networks:
  # Red para backend y DB
  backend-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  # Red para frontend y backend
  frontend-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ================================
# Volumes
# ================================
volumes:
  # PostgreSQL data (persistente)
  postgres_data:
    driver: local

  # NuGet packages cache
  backend_nuget:
    driver: local

  # Node modules cache
  frontend_node_modules:
    driver: local

  # PgAdmin data
  pgadmin_data:
    driver: local

# ==============================================
# Archivos Adicionales Requeridos:
# ==============================================

# .env (Development)
# ------------------
# PROJECT_NAME=myapp
# APP_VERSION=1.0.0
# DOCKER_BUILD_TARGET=development
#
# # Database
# DB_USER=postgres
# DB_PASSWORD=postgres_dev_password
# DB_NAME=myapp_dev
# DB_PORT=5432
#
# # Backend
# BACKEND_PORT=5000
# BACKEND_HTTPS_PORT=5001
# ASPNETCORE_ENVIRONMENT=Development
# LOG_LEVEL=Information
#
# # Frontend
# FRONTEND_PORT=5173
# FRONTEND_PROD_PORT=80
# VITE_API_URL=http://localhost:5000
#
# # JWT
# JWT_SECRET=your-super-secret-key-change-in-production
# JWT_ISSUER=myapp
# JWT_AUDIENCE=myapp-users
# JWT_EXPIRATION=60
#
# # Dev Tools
# PGADMIN_EMAIL=admin@admin.com
# PGADMIN_PASSWORD=admin
# PGADMIN_PORT=5050
# ADMINER_PORT=8080

# .env.production
# ---------------
# PROJECT_NAME=myapp
# APP_VERSION=1.0.0
# DOCKER_BUILD_TARGET=final
#
# DB_USER=myapp_user
# DB_PASSWORD=${DB_PASSWORD_FROM_SECRETS}
# DB_NAME=myapp_prod
#
# ASPNETCORE_ENVIRONMENT=Production
# LOG_LEVEL=Warning
#
# VITE_API_URL=https://api.ejemplo.com
#
# JWT_SECRET=${JWT_SECRET_FROM_SECRETS}

# ==============================================
# Uso:
# ==============================================
# Development:
#   docker compose up -d
#   docker compose logs -f backend
#   docker compose exec backend dotnet ef database update
#
# Development con PgAdmin:
#   docker compose --profile dev up -d
#
# Production:
#   docker compose --env-file .env.production up -d
#
# Parar todo:
#   docker compose down
#
# Parar y eliminar volumes:
#   docker compose down -v
#
# Ver logs:
#   docker compose logs -f
#
# Ejecutar migraciones:
#   docker compose exec backend dotnet ef database update
#
# Ejecutar tests:
#   docker compose exec backend dotnet test
#
# Acceder a base de datos:
#   docker compose exec db psql -U postgres -d myapp
# ==============================================
