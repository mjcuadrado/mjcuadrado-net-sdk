---
name: mj2-db-migrate
description: Gestiona migraciones de base de datos con EF Core (PostgreSQL + SQL Server)
tags: [database, migrations, ef-core, postgresql, sqlserver]
---

# /mj2:db-migrate - Database Migrations

Comando para invocar al agente **database-expert** y gestionar migraciones de base de datos con EF Core.

---

## üìã Uso

```bash
# Crear nueva migration
/mj2:db-migrate add MigrationName

# Aplicar migrations
/mj2:db-migrate update

# Rollback a migration anterior
/mj2:db-migrate rollback PreviousMigrationName

# Generar script SQL
/mj2:db-migrate script

# Remover √∫ltima migration (si no aplicada)
/mj2:db-migrate remove
```

---

## üéØ Par√°metros

### `add <nombre>`

Crea una nueva migration.

```bash
/mj2:db-migrate add InitialCreate
/mj2:db-migrate add AddOrdersTable
/mj2:db-migrate add UpdateCustomerSchema
```

**Workflow:**
1. Analiza cambios en DbContext y entities
2. Genera archivo de migration en `Migrations/`
3. Crea m√©todos `Up()` y `Down()`
4. Muestra diff de cambios

### `update [nombre]`

Aplica migrations a la base de datos.

```bash
# Aplicar todas las migrations pendientes
/mj2:db-migrate update

# Aplicar hasta una migration espec√≠fica
/mj2:db-migrate update AddOrdersTable

# Aplicar en environment espec√≠fico
/mj2:db-migrate update --environment Production
```

**Workflow:**
1. Verifica conexi√≥n a base de datos
2. Lista migrations pendientes
3. Genera SQL a ejecutar
4. Solicita confirmaci√≥n
5. Ejecuta migrations
6. Actualiza tabla `__EFMigrationsHistory`

### `rollback <nombre>`

Hace rollback a una migration anterior.

```bash
# Rollback a migration espec√≠fica
/mj2:db-migrate rollback InitialCreate

# Rollback completo (remove todas las migrations)
/mj2:db-migrate rollback 0
```

**Workflow:**
1. Identifica migration actual
2. Genera SQL para revertir cambios
3. Solicita confirmaci√≥n (‚ö†Ô∏è operaci√≥n destructiva)
4. Ejecuta rollback
5. Actualiza tabla `__EFMigrationsHistory`

### `script`

Genera script SQL de las migrations.

```bash
# Script de todas las migrations
/mj2:db-migrate script

# Script desde migration espec√≠fica
/mj2:db-migrate script --from InitialCreate

# Script entre dos migrations
/mj2:db-migrate script --from InitialCreate --to AddOrdersTable

# Script idempotente (puede ejecutarse m√∫ltiples veces)
/mj2:db-migrate script --idempotent
```

**Output:**
```sql
-- Migration: InitialCreate
CREATE TABLE "orders" (
    "id" integer GENERATED BY DEFAULT AS IDENTITY,
    "order_number" varchar(50) NOT NULL,
    "total" decimal(18,2) NOT NULL,
    CONSTRAINT "PK_orders" PRIMARY KEY ("id")
);

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20251122_InitialCreate', '9.0.0');
```

### `remove`

Elimina la √∫ltima migration (si no ha sido aplicada).

```bash
/mj2:db-migrate remove
```

**Workflow:**
1. Verifica que la migration NO est√© aplicada
2. Elimina archivos de migration
3. Restaura estado del ModelSnapshot

---

## üí° Ejemplos de Uso

### Ejemplo 1: Primera Migration

```bash
# 1. Definir entities
# Order.cs, Customer.cs, Product.cs

# 2. Crear migration inicial
/mj2:db-migrate add InitialCreate

# Output:
# ‚úÖ Migration creada: Migrations/20251122_InitialCreate.cs
# üìä Cambios detectados:
#    + orders table
#    + customers table
#    + products table

# 3. Revisar migration generada
cat Migrations/20251122_InitialCreate.cs

# 4. Aplicar migration
/mj2:db-migrate update

# Output:
# üîç Migrations pendientes:
#    ‚Ä¢ InitialCreate
#
# üìä SQL a ejecutar:
#    CREATE TABLE orders ...
#    CREATE TABLE customers ...
#
# ¬øContinuar? (y/N): y
#
# ‚úÖ Migration aplicada exitosamente
# ‚úÖ Database actualizada
```

### Ejemplo 2: Agregar Columna

```bash
# 1. Modificar entity
public class Order
{
    public int Id { get; set; }
    public string OrderNumber { get; set; }
    public string Status { get; set; }  // ‚Üê Nueva propiedad
}

# 2. Crear migration
/mj2:db-migrate add AddOrderStatus

# Output:
# ‚úÖ Migration creada
# üìä Cambios:
#    + Column: orders.status (varchar(50))

# 3. Aplicar
/mj2:db-migrate update
```

### Ejemplo 3: Deploy a Producci√≥n

```bash
# 1. Generar script SQL (NO ejecutar migrations directamente en prod)
/mj2:db-migrate script --idempotent > migration.sql

# 2. Revisar script
cat migration.sql

# 3. Aplicar manualmente en producci√≥n
# PostgreSQL:
psql -h prod-db.example.com -U app_user -d mydb < migration.sql

# SQL Server:
sqlcmd -S prod-db.example.com -U app_user -d MyDatabase -i migration.sql

# 4. Verificar
psql -h prod-db.example.com -U app_user -d mydb -c "SELECT * FROM \"__EFMigrationsHistory\""
```

### Ejemplo 4: Rollback

```bash
# Algo sali√≥ mal con la √∫ltima migration
/mj2:db-migrate rollback PreviousMigrationName

# Output:
# ‚ö†Ô∏è ADVERTENCIA: Rollback eliminar√° datos si hay DROP COLUMN
#
# üìä SQL a ejecutar:
#    DROP TABLE new_table;
#    ALTER TABLE orders DROP COLUMN status;
#
# ¬øContinuar? (y/N): y
#
# ‚úÖ Rollback completado
# ‚ö†Ô∏è Revisar y corregir migration antes de re-aplicar
```

---

## ‚ö†Ô∏è Precauciones

### 1. Migrations en Producci√≥n

```bash
# ‚ùå NUNCA ejecutar directamente en producci√≥n
/mj2:db-migrate update  # En producci√≥n

# ‚úÖ Generar script y aplicar manualmente
/mj2:db-migrate script --idempotent > migration.sql
# Revisar script
# Aplicar en ventana de mantenimiento
```

### 2. Backups Antes de Migration

```bash
# PostgreSQL
pg_dump -h localhost -U user -d mydb > backup_pre_migration.sql

# SQL Server
BACKUP DATABASE MyDatabase TO DISK = 'C:\Backups\pre_migration.bak'

# Luego aplicar migration
/mj2:db-migrate update
```

### 3. Testing en Staging Primero

```bash
# 1. Aplicar en dev
/mj2:db-migrate update

# 2. Aplicar en staging
/mj2:db-migrate update --environment Staging

# 3. Validar en staging
# Run integration tests
# Validate data integrity

# 4. Solo entonces, aplicar en producci√≥n
```

---

## üîó Integraci√≥n con Otros Comandos

### Workflow Full-Stack

```bash
# 1. Dise√±ar entities y DbContext
# Order.cs, Customer.cs, ApplicationDbContext.cs

# 2. Crear migration (database-expert)
/mj2:db-migrate add InitialCreate

# 3. Aplicar migration
/mj2:db-migrate update

# 4. Implementar repository (tdd-implementer)
/mj2:2-run REPO-ORDERS-001

# 5. Tests de integraci√≥n con Testcontainers
/mj2:2-run TEST-INTEGRATION-001

# 6. Deploy con migrations (devops-expert)
/mj2:5-deploy staging --run-migrations
```

---

## üìö Ver Tambi√©n

- Agente: `.claude/agents/mj2/database-expert.md`
- Skills:
  - `.claude/skills/dotnet/postgresql.md`
  - `.claude/skills/dotnet/sqlserver.md`
  - `.claude/skills/dotnet/ef-core.md`
- Comandos relacionados:
  - `/mj2:2-run` - TDD implementation
  - `/mj2:5-deploy` - Deployment

---

**Versi√≥n:** 1.0.0
**√öltima Actualizaci√≥n:** 2025-11-22
**Mantenido por:** mjcuadrado-net-sdk
